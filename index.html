<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MK Admin - SprÃ¡va RezervacÃ­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDlqIg_mBdte2-LltvcuuOdXFBrTVntrs0",
          authDomain: "marykaypozvanka.firebaseapp.com",
          projectId: "marykaypozvanka",
          storageBucket: "marykaypozvanka.firebasestorage.app",
          messagingSenderId: "545039603070",
          appId: "1:545039603070:web:4db8a4d3b4fff548458f2f",
          measurementId: "G-GP7CY3Y7QS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'marykaypozvanka';

        let curYear, curMonth, selectedDate = null;
        let slots = [], appointments = [];
        let unsubSlots = null, unsubAppts = null;
        let currentUser = null;

        const tToM = (t) => {
            const [h, m] = t.split(':').map(Number);
            return h * 60 + m;
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (!user) {
                signInAnonymously(auth).catch(err => console.error("Auth Error:", err));
            }
        });

        window.checkPin = () => {
            if (document.getElementById('admin-pin').value === "1234") {
                document.getElementById('login-overlay').style.display = 'none';
                startListening();
            } else { alert("Å patnÃ½ PIN!"); }
        };

        function startListening() {
            const n = new Date(); curYear = n.getFullYear(); curMonth = n.getMonth();
            unsubSlots = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'slots'), (s) => {
                slots = []; s.forEach(d => slots.push({id: d.id, ...d.data()}));
                render(); if (selectedDate) renderGrid();
            });
            unsubAppts = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'appointments'), (s) => {
                appointments = []; s.forEach(d => appointments.push({id: d.id, ...d.data()}));
                render(); if (selectedDate) renderGrid();
                renderList();
            });
        }

        function render() {
            const grid = document.getElementById('cal-grid'); if(!grid) return; grid.innerHTML = '';
            const fDay = new Date(curYear, curMonth, 1).getDay() || 7;
            const days = new Date(curYear, curMonth + 1, 0).getDate();
            document.getElementById('mon-label').innerText = new Intl.DateTimeFormat('cs-CZ', {month:'long', year:'numeric'}).format(new Date(curYear, curMonth));
            for(let i=1; i<fDay; i++) grid.innerHTML += '<div></div>';
            for(let d=1; d<=days; d++) {
                const date = new Date(curYear, curMonth, d);
                const dStr = date.toISOString().split('T')[0];
                const isWE = date.getDay() === 0 || date.getDay() === 6;
                const hasS = slots.some(s => s.date === dStr);
                const isS = selectedDate === dStr;
                const el = document.createElement('div');
                el.className = `p-2 text-center text-xs rounded-lg cursor-pointer border ${isWE ? 'bg-gray-100 text-gray-300' : 'hover:bg-pink-50'} ${isS ? 'border-pink-500 ring-1 ring-pink-200' : 'border-transparent'} ${hasS && !isWE ? 'bg-pink-100 font-bold' : ''}`;
                el.innerText = d;
                if(!isWE) el.onclick = () => { selectedDate = dStr; render(); renderGrid(); };
                grid.appendChild(el);
            }
        }

        function renderGrid() {
            const g = document.getElementById('time-grid'); if(!g) return; g.innerHTML = '';
            const formattedDate = new Date(selectedDate).toLocaleDateString('cs-CZ');
            document.getElementById('date-label').innerText = formattedDate;
            for(let h=9; h<=17; h++) {
                for(let m of ['00','15','30','45']) {
                    if(h===17 && m!=='00') break;
                    const t = `${h.toString().padStart(2,'0')}:${m}`;
                    const label = `${formattedDate} v ${t}`;
                    const isBooked = appointments.some(a => a.appointment === label);
                    const isOpenStart = slots.some(s => s.date === selectedDate && s.time === t);
                    const btn = document.createElement('button');
                    btn.className = `p-2 text-[10px] rounded border transition-all ${isBooked ? 'bg-gray-800 text-white' : isOpenStart ? 'bg-pink-500 text-white shadow-md' : 'bg-white text-gray-600'}`;
                    btn.innerText = isBooked ? 'REZE' : t;
                    if(!isBooked) btn.onclick = () => toggle(selectedDate, t, isOpenStart);
                    g.appendChild(btn);
                }
            }
        }

        async function toggle(d, t, status) {
            const id = `${d}_${t.replace(':','')}`;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'slots', id);
            if(status) await deleteDoc(ref); else await setDoc(ref, {date:d, time:t});
        }

        function renderList() {
            const list = document.getElementById('admin-list'); if(!list) return; list.innerHTML = '';
            const items = [...appointments].sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
            items.forEach(d => {
                const tr = document.createElement('tr');
                tr.className = "border-b text-[11px]";
                tr.innerHTML = `<td class="p-3"><b>${d.name}</b><br>${d.phone}</td>
                    <td class="p-3 text-pink-600 font-bold">${d.appointment}</td>
                    <td class="p-3">${d.withFriend ? 'ðŸ‘¥ Ano' : 'Sama'}</td>
                    <td class="p-3 text-right"><button onclick="del('${d.id}')" class="text-red-400">SMAZAT</button></td>`;
                list.appendChild(tr);
            });
        }

        window.del = async (id) => { if(confirm('Smazat?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'appointments', id)); };
        window.changeMon = (dir) => { curMonth += dir; if(curMonth<0){curMonth=11;curYear--;} if(curMonth>11){curMonth=0;curYear++;} render(); };
    </script>
</head>
<body class="bg-gray-50 font-[Montserrat] min-h-screen text-gray-800">
    <div id="login-overlay" class="fixed inset-0 bg-pink-600 flex items-center justify-center z-[100] p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center">
            <h1 class="text-2xl font-bold mb-6 text-pink-600 italic">MK Admin</h1>
            <input id="admin-pin" type="password" placeholder="PIN 1234" class="w-full p-4 border rounded-xl mb-4 text-center text-2xl outline-none">
            <button onclick="checkPin()" class="w-full py-4 bg-pink-600 text-white rounded-xl font-bold">Vstoupit</button>
        </div>
    </div>
    <main class="max-w-7xl mx-auto p-4 grid lg:grid-cols-12 gap-6">
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-white p-5 rounded-3xl shadow border">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="changeMon(-1)">&lt;</button>
                    <h2 id="mon-label" class="font-bold">Leden</h2>
                    <button onclick="changeMon(1)">&gt;</button>
                </div>
                <div id="cal-grid" class="grid grid-cols-7 gap-1 text-[10px]"></div>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow border">
                <h3 class="font-bold text-sm mb-4">ÄŒasy: <span id="date-label" class="text-pink-500">-</span></h3>
                <div id="time-grid" class="grid grid-cols-4 gap-2"></div>
            </div>
        </div>
        <div class="lg:col-span-8 bg-white rounded-3xl shadow overflow-hidden border">
            <table class="w-full text-left">
                <thead class="bg-gray-50 text-[10px] uppercase font-bold text-gray-400 border-b">
                    <tr><th class="p-3">ZÃ¡kaznice</th><th class="p-3">TermÃ­n</th><th class="p-3">Doprovod</th><th class="p-3"></th></tr>
                </thead>
                <tbody id="admin-list" class="divide-y divide-gray-50"></tbody>
            </table>
        </div>
    </main>
</body>
</html>
